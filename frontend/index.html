<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ZenChess</title>
  <link rel="stylesheet" href="https://unpkg.com/chessground@8.3.11/assets/chessground.base.css">
  <link rel="stylesheet" href="https://unpkg.com/chessground@8.3.11/assets/chessground.brown.css">
  <link rel="stylesheet" href="https://unpkg.com/chessground@8.3.11/assets/chessground.cburnett.css">
  <style>
    body {
      margin: 0;
      padding: 20px;
      background: #1a1a1a;
      color: #fff;
      font-family: system-ui, -apple-system, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }
    h1 { margin-bottom: 2rem; }
    #board { 
      width: 600px;
      height: 600px;
      margin-bottom: 1rem;
    }
    .buttons {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    button {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    #checkBtn {
      background: #10b981;
      color: white;
    }
    #checkBtn:hover:not(:disabled) {
      background: #059669;
    }
    #newBtn {
      background: #3b82f6;
      color: white;
    }
    #newBtn:hover:not(:disabled) {
      background: #2563eb;
    }
    #feedback {
      font-size: 1.25rem;
      min-height: 30px;
    }
  </style>
</head>
<body>
  <h1>ZenChess Puzzle</h1>
  <div id="board"></div>
  <div class="buttons">
    <button id="checkBtn">Check Balance</button>
    <button id="newBtn">New Puzzle</button>
  </div>
  <div id="feedback"></div>

  <script type="module">
    import { Chessground } from 'https://cdnjs.cloudflare.com/ajax/libs/chessground/9.2.1/chessground.min.js'
    import { Chess } from 'https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.13.4/chess.js'

    const chess = new Chess()
    let currentPuzzle = null
    
    const board = Chessground(document.getElementById('board'), {
      fen: chess.fen(),
      coordinates: true,
      movable: {
        free: false,
        color: 'white',
        events: {
          after: (orig, dest) => {
            const move = chess.move({
              from: orig,
              to: dest,
              promotion: 'q'
            })
            
            if (move) {
              board.set({ fen: chess.fen() })
            } else {
              // Invalid move, reset board
              board.set({ fen: chess.fen() })
            }
          }
        }
      },
      events: {
        move: (orig, dest) => {
          // Validate move
          const moves = chess.moves({ verbose: true })
          const validMove = moves.find(m => m.from === orig && m.to === dest)
          return !!validMove
        }
      }
    })

    const checkBtn = document.getElementById('checkBtn')
    const newBtn = document.getElementById('newBtn')
    const feedback = document.getElementById('feedback')

    async function loadPuzzle() {
      try {
        checkBtn.disabled = true
        newBtn.disabled = true
        feedback.textContent = 'Loading puzzle...'

        const res = await fetch('/api/v1/puzzles/random')
        const data = await res.json()
        
        console.log('Puzzle data:', data)
        
        if (data.results && data.results.length > 0) {
          currentPuzzle = data.results[0]
          console.log('Loading FEN:', currentPuzzle.fen)
          chess.load(currentPuzzle.fen)
          
          // Determine side to move
          const turn = chess.turn() === 'w' ? 'white' : 'black'
          
          board.set({
            fen: currentPuzzle.fen,
            turnColor: turn,
            movable: {
              color: turn,
              free: false,
              dests: getValidMoves()
            }
          })
          
          feedback.textContent = `Find the balancing move! (${currentPuzzle.eval_before}cp → ${currentPuzzle.eval_after}cp)`
        } else {
          feedback.textContent = 'No puzzles available'
        }
      } catch (error) {
        console.error('Error loading puzzle:', error)
        feedback.textContent = 'Error loading puzzle'
      } finally {
        checkBtn.disabled = false
        newBtn.disabled = false
      }
    }

    function getValidMoves() {
      const dests = new Map()
      chess.moves({ verbose: true }).forEach(move => {
        if (!dests.has(move.from)) {
          dests.set(move.from, [])
        }
        dests.get(move.from).push(move.to)
      })
      return dests
    }

    function checkBalance() {
      if (!currentPuzzle) {
        feedback.textContent = '❌ Load a puzzle first!'
        return
      }
      
      const history = chess.history({ verbose: true })
      if (history.length === 0) {
        feedback.textContent = '❌ Make a move first!'
        return
      }

      const lastMove = history[history.length - 1]
      const userMove = lastMove.from + lastMove.to

      console.log('User move:', userMove, 'Expected:', currentPuzzle.move_uci)

      if (userMove === currentPuzzle.move_uci) {
        feedback.textContent = `✅ Correct! ${currentPuzzle.eval_before}cp → ${currentPuzzle.eval_after}cp`
        checkBtn.disabled = true
        board.set({ movable: { color: undefined } }) // Disable further moves
      } else {
        feedback.textContent = `❌ Wrong move. Try again!`
        chess.undo()
        board.set({
          fen: chess.fen(),
          movable: {
            color: chess.turn() === 'w' ? 'white' : 'black',
            dests: getValidMoves()
          }
        })
      }
    }

    checkBtn.addEventListener('click', checkBalance)
    newBtn.addEventListener('click', loadPuzzle)

    loadPuzzle()
  </script>
</body>
</html>